<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Den Hartog P4</title>

  <script src="gl-matrix.js"></script>
  <script src="bones.js"></script>
  <script src="animation.js"></script>
  <script src="inputManager.js"></script>
  <script src="renderer.js"></script>
  <script src="model.js"></script>
  <script src="g3djLib.js"></script>
  <script src="monkey.g3dj"></script>
  <style type="text/css">
    canvas {
        border: 1px solid #d3d3d3;
    }
  </style>
</head>
<body>
Displaying monkey.g3dj at <span id="fps"></span> fps<br>
<canvas id="canvas" width="750" height="550"></canvas><br>
Light Rotation Speed: <input style="width:400px;" id="lightspeed" type="range" min ="0.0000125" max="0.009125" step =".000001" value="0.0000325"/>
<p>Use WASD to rotate the object in the viewer and Shift and Control to zoom in and out.</p>
<p>The rotation speed slider has an intentionally huge maximum value because it can cause some cool strobing effects depending on frame rate.</p>
<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext('2d');
//put 0,0 in the center of the canvas
ctx.setTransform(1, 0, 0, -1, canvas.width / 2, canvas.height / 2);

//load a g3dj file
var model = g3djLib.parseModel(monkey_obj);

var cameraPosition = vec3.fromValues(0,7,20);
var projection = mat4.create();
mat4.perspective(projection, Math.PI / 2, canvas.width / canvas.height, 2, 30);

var renderer = new renderLib.renderer(canvas, ctx);

var prev = 0;
function loop(timestamp) {
  var delta = prev == 0 ? 0 : (timestamp - prev);
  prev = timestamp;

  document.getElementById("fps").innerHTML = (1000.0 / delta).toFixed(0);

  var cameraMatrix = mat4.create();
  mat4.lookAt(cameraMatrix, cameraPosition, [0,0,0], [0,1,0]);

  //clear the canvas
  ctx.fillStyle="black";
  ctx.fillRect(-canvas.width/2, -canvas.height/2, canvas.width, canvas.height);
  //transform by camera matrix
  var transform = mat4.create();
  mat4.multiply(transform, cameraMatrix, transform);
  mat4.multiply(transform, projection, transform);

  //draw model
  model.draw(renderer);

  //render scene
  renderer.renderFrame(transform);

  //HANDLE INPUT
  if(inputManager.keyboardState[65]) //a
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[68]) //d
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, -Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[87] || inputManager.keyboardState[83]) //w or s
  {
    var dir = inputManager.keyboardState[83] ? -1 : 1;

    var rotateAxis = vec3.create();
    vec3.cross(rotateAxis, cameraPosition, [0,1,0]);
    vec3.normalize(rotateAxis,rotateAxis);
    var rotationMatrix = mat4.create();
    mat4.rotate(rotationMatrix, rotationMatrix, Math.PI/2000 * delta * dir, rotateAxis);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[16] && vec3.len(cameraPosition) > 10) //shift
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.sub(cameraPosition, cameraPosition, cameraMove);
  }

  if(inputManager.keyboardState[17]) //ctl
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.add(cameraPosition, cameraPosition, cameraMove);
  }
  
  window.requestAnimationFrame(loop);
}
loop(0);

</script>
</body>
</html>