<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Den Hartog P6</title>

  <script src="gl-matrix.js"></script>
  <script src="twgl-full.min.js"></script>
  <script src="bones.js"></script>
  <script src="animation.js"></script>
  <script src="inputManager.js"></script>
  <script src="renderer.js"></script>
  <script src="model.js"></script>
  <script src="g3djLib.js"></script>
  <script src="monkey.g3dj"></script>
  <style type="text/css">
    canvas {
        border: 1px solid #d3d3d3;
    }
  </style>
</head>
<body>
Displaying monkey.g3dj at <span id="fps"></span> fps<br>
<canvas id="canvas" width="750" height="550"></canvas><br>
Light Rotation Speed: <input style="width:400px;" id="lightspeed" type="range" min ="0.00125" max="0.09125" step =".00001" value="0.00125"/>
<p>Use WASD to rotate the object in the viewer and Shift and Control to zoom in and out.</p>
<p>The rotation speed slider has an intentionally huge maximum value because it can cause some cool strobing effects depending on frame rate.</p>
<script id="vs" type="notjs">
attribute vec4 position;
attribute vec3 normal;
uniform mat4 viewTransform;

uniform mat4 worldTransform;
//model world normal transform
uniform mat3 normalTransform;

varying vec3 worldNormal;
varying vec4 worldPosition;
void main() {
  worldPosition = worldTransform * position;
  vec4 pos = viewTransform * worldPosition;

  worldNormal = normalTransform * normal;
  gl_Position = pos;
}
</script>
<script id="fs" type="notjs">
precision mediump float;
uniform vec2 resolution;
uniform float time;
uniform vec3 lightVector;

varying vec3 worldNormal;
varying vec4 worldPosition;

vec2 blinnPhongDir(float lightInt, float Ka, float Kd, float Ks, float shininess)
{
  vec3 s = normalize(lightVector);
  vec3 v = normalize(-worldPosition.xyz);
  vec3 n = normalize(worldNormal);
  vec3 h = normalize(v+s);
  float diffuse = Ka + Kd * lightInt * max(0.0, dot(n, s));
  float spec =  Ks * pow(max(0.0, dot(n,h)), shininess);
  return vec2(diffuse, spec);
}

void main() {
  vec3 base = vec3(0.2,0.0,0.4);
  vec3 color = vec3(0.0,0.5,0.0);
  float diff = clamp(dot(worldNormal, lightVector),0.0,1.0);
  float backlight = clamp(dot(worldNormal, vec3(-1,-1,-0.5)), 0.0, 1.0);;
  gl_FragColor = vec4(base*backlight + color * diff, 1.0);
}
</script>
<script>
var gl = twgl.getWebGLContext(document.getElementById("canvas"));

//load a g3dj file
var model = g3djLib.parseModel(monkey_obj);
model.createGLBuffers(gl);

var cameraPosition = vec3.fromValues(0,7,15);
var projection = mat4.create();
mat4.perspective(projection, Math.PI / 2, canvas.width / canvas.height, 1, 60);

var renderer = new renderLib.renderer(gl);

var prev = 0;
function loop(timestamp) {
  var delta = prev == 0 ? 0 : (timestamp - prev);
  prev = timestamp;

  document.getElementById("fps").innerHTML = (1000.0 / delta).toFixed(0);

  var cameraMatrix = mat4.create();
  mat4.lookAt(cameraMatrix, cameraPosition, [0,0,0], [0,1,0]);

  //transform by camera matrix
  var transform = mat4.create();
  mat4.multiply(transform, cameraMatrix, transform);
  mat4.multiply(transform, projection, transform);

  //render scene
  renderer.renderFrame(transform, [model], delta);

  handleInput(delta);
  window.requestAnimationFrame(loop);
}

function handleInput(delta) {
  //HANDLE INPUT
  if(inputManager.keyboardState[65]) //a
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[68]) //d
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, -Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[87] || inputManager.keyboardState[83]) //w or s
  {
    var dir = inputManager.keyboardState[83] ? -1 : 1;

    var rotateAxis = vec3.create();
    vec3.cross(rotateAxis, cameraPosition, [0,1,0]);
    vec3.normalize(rotateAxis,rotateAxis);
    var rotationMatrix = mat4.create();
    mat4.rotate(rotationMatrix, rotationMatrix, Math.PI/2000 * delta * dir, rotateAxis);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[16] && vec3.len(cameraPosition) > 10) //shift
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.sub(cameraPosition, cameraPosition, cameraMove);
  }

  if(inputManager.keyboardState[17]) //ctl
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.add(cameraPosition, cameraPosition, cameraMove);
  }
}

loop(0);

</script>
</body>
</html>