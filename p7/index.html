<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Den Hartog P7</title>

  <script src="gl-matrix.js"></script>
  <script src="twgl.min.js"></script>
  <script src="entity.js"></script>
  <script src="bones.js"></script>
  <script src="animation.js"></script>
  <script src="inputManager.js"></script>
  <script src="renderer.js"></script>
  <script src="model.js"></script>
  <script src="g3djLib.js"></script>
  <script src="world.js"></script>
  <script src="scene.g3dj"></script>
  <style type="text/css">
    canvas {
        border: 1px solid #d3d3d3;
    }
  </style>
</head>
<body>
Displaying scene.g3dj at <span id="fps"></span> fps<br>
<canvas id="canvas" width="900" height="700"></canvas><br>
Time of day: <input style="width:400px;" id="lightangle" type="range" min ="0.0" max="2.8" step =".05" value="0"/>
<p>Use middle or right click to rotate the viewer and W and S to zoom in and out.</p>
<script id="vs" type="notjs">
precision mediump float;
attribute vec4 POSITION;
attribute vec3 NORMAL;
attribute vec2 BLENDWEIGHT0;
attribute vec2 BLENDWEIGHT1;
attribute vec2 BLENDWEIGHT2;
attribute vec2 BLENDWEIGHT3;
attribute vec2 BLENDWEIGHT4;
attribute vec2 BLENDWEIGHT5;
attribute vec2 BLENDWEIGHT6;

uniform mat4 viewProjection;

uniform mat4 worldTransform;
//model world normal transform
uniform mat3 normalTransform;

varying vec3 worldNormal;
varying vec4 worldPosition;

void main() {
  //vertex position in world coords
  worldPosition = worldTransform * POSITION;

  //in normalized device coords
  vec4 pos = viewProjection * worldPosition;

  worldNormal = normalTransform * NORMAL;
  gl_Position = pos;
}
</script>
<script id="fs" type="notjs">
precision mediump float;
uniform vec2 resolution;
uniform float time;
uniform vec3 lightVector;
//actual position in world coordinates of the camera
uniform vec3 cameraPosition;

uniform vec3 mat_diffuse;
uniform vec3 mat_specular;

varying vec3 worldNormal;
varying vec4 worldPosition;

vec2 blinnPhongDir(vec3 lightDir, float Ka, float Kd, float Ks, float shininess)
{
  vec3 s = normalize(lightDir);
  //vector from the camera to the point in the world
  vec3 v = normalize(cameraPosition-worldPosition.xyz);
  vec3 n = normalize(worldNormal);
  vec3 h = normalize(v+s);
  float diffuse = Ka + Kd * max(0.0, dot(n, s));
  float spec =  Ks * pow(max(0.0, dot(n,h)), shininess);
  return vec2(diffuse, spec);
}

void main() {
  vec2 phong = blinnPhongDir(lightVector, 1.0, 1.0, 0.5, 5.0)*.8;
  phong += blinnPhongDir(-lightVector, 1.0, 1.0, 0.0, 5.0)*.8;
  vec3 diffColor = mat_diffuse * phong.x;
  vec3 specColor = mat_specular * phong.y;
  gl_FragColor = vec4(diffColor + specColor, 1.0);
}
</script>
<script>
var gl = twgl.getWebGLContext(document.getElementById("canvas"));

//load a g3dj file
var models = g3djLib.parseModel(loaded_obj);
modelLib.createGLBuffersForDict(gl, models);

world.init(models, vec3.fromValues(15,15,20));

var projection = mat4.create();
mat4.perspective(projection, Math.PI / 3, canvas.width / canvas.height, 1, 200);

var renderer = new renderLib.renderer(gl);

var prev = 0;
var lastX=null, lastY=null;
function loop(timestamp) {
  var delta = prev == 0 ? 0 : (timestamp - prev);
  prev = timestamp;

  document.getElementById("fps").innerHTML = (1000.0 / delta).toFixed(0);

  var cameraMatrix = mat4.create();
  mat4.lookAt(cameraMatrix, world.cameraPosition, [0,0,0], [0,1,0]);

  var viewProjection = mat4.create();
  mat4.multiply(viewProjection, cameraMatrix, viewProjection);
  mat4.multiply(viewProjection, projection, viewProjection);
  //render scene
  renderer.renderFrame(viewProjection, world.cameraPosition, models, delta);

  world.handleInput(delta, inputManager);

  //models.pig.translation[0] = 8 + 6*Math.sin(timestamp/1000);
  //models.pig.translation[2] = 6 + 6*Math.cos(timestamp/1000);
  // var nothing = quat.create();
  // quat.rotateX(models.pig.rotation, nothing, (timestamp/1000) + Math.PI/4);

  window.requestAnimationFrame(loop);
}

loop(0);

</script>
</body>
</html>