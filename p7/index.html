<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Den Hartog P7</title>

  <script src="gl-matrix.js"></script>
  <script src="twgl.min.js"></script>
  <script src="entity.js"></script>
  <script src="bones.js"></script>
  <script src="animation.js"></script>
  <script src="inputManager.js"></script>
  <script src="renderer.js"></script>
  <script src="model.js"></script>
  <script src="g3djLib.js"></script>
  <script src="lilcowboy.g3dj"></script>
  <style type="text/css">
    html, body {
      width:  100%;
      height: 100%;
    }
    canvas {
        border: 1px solid #d3d3d3;
    }
  </style>
</head>
<body>
Displaying lilcowboy.g3dj and monkey.g3dj at <span id="fps"></span> fps<br>
<canvas id="canvas" width="900" height="700"></canvas><br>
Light Rotation Speed: <input style="width:400px;" id="lightspeed" type="range" min ="0.0" max="0.09125" step =".00001" value="0.00125"/>
<p>Use WASD to rotate the object in the viewer and Shift and Control to zoom in and out.</p>
<script id="vs" type="notjs">
precision mediump float;
attribute vec4 position;
attribute vec3 normal;

uniform mat4 viewProjection;

uniform mat4 worldTransform;
//model world normal transform
uniform mat3 normalTransform;

varying vec3 worldNormal;
varying vec4 worldPosition;

void main() {
  //vertex position in world coords
  worldPosition = worldTransform * position;

  //in normalized device coords
  vec4 pos = viewProjection * worldPosition;

  worldNormal = normalTransform * normal;
  gl_Position = pos;
}
</script>
<script id="fs" type="notjs">
precision mediump float;
uniform vec2 resolution;
uniform float time;
uniform vec3 lightVector;
//actual position in world coordinates of the camera
uniform vec3 cameraPosition;

varying vec3 worldNormal;
varying vec4 worldPosition;

vec2 blinnPhongDir(vec3 lightDir, float lightInt, float Ka, float Kd, float Ks, float shininess)
{
  vec3 s = normalize(lightDir);
  //vector from the camera to the point in the world
  vec3 v = normalize(cameraPosition-worldPosition.xyz);
  vec3 n = normalize(worldNormal);
  vec3 h = normalize(v+s);
  float diffuse = Ka + Kd * lightInt * max(0.0, dot(n, s));
  float spec =  Ks * pow(max(0.0, dot(n,h)), shininess);
  return vec2(diffuse, spec);
}

void main() {
  vec2 phong = blinnPhongDir(lightVector, 5.0, .15, .2, 1.0, 5.0)*.8;
  phong += blinnPhongDir(-lightVector, 5.0, .15, .2, 1.0, 5.0)*.2;
  vec3 diffColor = vec3(1.0,0.0,1.0) * phong.x;
  vec3 specColor = vec3(0,1.0,1.0) * phong.y;
  gl_FragColor = vec4(diffColor + specColor, 1.0);
}
</script>
<script>
var gl = twgl.getWebGLContext(document.getElementById("canvas"));

//load a g3dj file
var models = g3djLib.parseModel(loaded_obj);
modelLib.createGLBuffersForDict(gl, models);

var cameraPosition = vec3.fromValues(0,5,35);
var projection = mat4.create();
mat4.perspective(projection, Math.PI / 3, canvas.width / canvas.height, 1, 60);

var renderer = new renderLib.renderer(gl);

var prev = 0;
function loop(timestamp) {
  var delta = prev == 0 ? 0 : (timestamp - prev);
  prev = timestamp;

  document.getElementById("fps").innerHTML = (1000.0 / delta).toFixed(0);

  var cameraMatrix = mat4.create();
  mat4.lookAt(cameraMatrix, cameraPosition, [0,0,0], [0,1,0]);

  var viewProjection = mat4.create();
  mat4.multiply(viewProjection, cameraMatrix, viewProjection);
  mat4.multiply(viewProjection, projection, viewProjection);
  //render scene
  renderer.renderFrame(viewProjection, cameraPosition, models, delta);

  handleInput(delta);
  window.requestAnimationFrame(loop);
}

function handleInput(delta) {
  //HANDLE INPUT
  if(inputManager.keyboardState[65]) //a
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[68]) //d
  {
    var rotationMatrix = mat4.create();
    mat4.rotateY(rotationMatrix, rotationMatrix, -Math.PI/2000 * delta);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[87] || inputManager.keyboardState[83]) //w or s
  {
    var dir = inputManager.keyboardState[83] ? -1 : 1;

    var rotateAxis = vec3.create();
    vec3.cross(rotateAxis, cameraPosition, [0,1,0]);
    vec3.normalize(rotateAxis,rotateAxis);
    var rotationMatrix = mat4.create();
    mat4.rotate(rotationMatrix, rotationMatrix, Math.PI/2000 * delta * dir, rotateAxis);
    vec3.transformMat4(cameraPosition, cameraPosition, rotationMatrix);
  }

  if(inputManager.keyboardState[16] && vec3.len(cameraPosition) > 10) //shift
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.sub(cameraPosition, cameraPosition, cameraMove);
  }

  if(inputManager.keyboardState[17]) //ctl
  {
    var cameraMove = vec3.create();
    vec3.normalize(cameraMove,cameraPosition);
    vec3.add(cameraPosition, cameraPosition, cameraMove);
  }
}

loop(0);

</script>
</body>
</html>